// ============================================================================
// Capital Bridge Nepal - Prisma Schema
// Investment Discovery Platform
// ============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum BusinessStatus {
  PENDING
  APPROVED
  REJECTED
}

enum MediaType {
  // Documents
  REGISTRATION_CERTIFICATE  // Company Registration Certificate
  PAN_CERTIFICATE           // PAN Certificate
  FINANCIAL_DOCUMENT        // Financial Documents
  PITCH_DECK                // Pitch Deck
  BROCHURE                  // Brochures
  DOCUMENT                  // Other Documents

  // Media
  COMPANY_LOGO              // Company Logo
  GALLERY                   // Gallery images (up to 6)
  IMAGE                     // General images
  VIDEO                     // Uploaded videos
  YOUTUBE_VIDEO             // YouTube video links
  WEBSITE                   // Website links
}

enum MediaApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum OnboardingStatus {
  PENDING
  CONTACTED
  APPROVED
  REJECTED
}

// ============================================================================
// MODELS
// ============================================================================

// Admin Authentication
model Admin {
  id           String   @id @default(uuid()) @db.Uuid
  email        String   @unique @db.VarChar(255)
  passwordHash String   @map("password_hash") @db.VarChar(255)
  username     String   @db.VarChar(100)
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@index([email])
  @@map("admins")
}

// Business Login/Authentication
model BusinessLogin {
  id           String   @id @default(uuid()) @db.Uuid
  email        String   @unique @db.VarChar(255)
  passwordHash String   @map("password_hash") @db.VarChar(255)
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  business          Business?
  onboardingRequest BusinessOnboardingRequest? @relation("BusinessLoginOnboardingRequest")

  @@index([email])
  @@map("business_logins")
}

// Categories (Business categories like Tech, Fintech, etc.)
model Category {
  id          Int        @id @default(autoincrement())
  name        String     @unique @db.VarChar(100)
  slug        String     @unique @db.VarChar(100)
  description String?    @db.Text
  createdAt   DateTime   @default(now()) @map("created_at")

  // Relations
  businesses  Business[]

  @@map("categories")
}

// Businesses (Main business information)
model Business {
  id                        String         @id @default(uuid()) @db.Uuid
  businessLoginId           String         @unique @map("business_login_id") @db.Uuid

  // Basic Information
  name                      String         @db.VarChar(100)
  registrationNumber        String         @unique @map("registration_number") @db.VarChar(100)
  categoryId                Int            @map("category_id")

  // Business Type & Details
  businessType              String         @map("business_type") @db.VarChar(100) // "Pvt. Ltd.", "Public Ltd.", etc.
  yearEstablished           Int            @map("year_established")
  location                  String         @db.VarChar(100) // "Kathmandu", "Pokhara", etc.
  teamSize                  String         @map("team_size") @db.VarChar(50) // "1-5 employees", etc.

  // Financial Information
  paidUpCapital             Decimal        @map("paid_up_capital") @db.Decimal(15, 2)
  investmentCapacityMin     Decimal        @map("investment_capacity_min") @db.Decimal(15, 2)
  investmentCapacityMax     Decimal        @map("investment_capacity_max") @db.Decimal(15, 2)

  // Investment Parameters
  minimumInvestmentUnits    Int?           @map("minimum_investment_units") // Minimum number of units an investor can purchase
  maximumInvestmentUnits    Int?           @map("maximum_investment_units") // Maximum number of units an investor can purchase
  pricePerUnit              Decimal?       @map("price_per_unit") @db.Decimal(15, 2)
  expectedReturnOptions     String?        @map("expected_return_options") @db.VarChar(255) // e.g., "IPO Exit, Dividend"
  estimatedMarketValuation  Decimal?       @map("estimated_market_valuation") @db.Decimal(15, 2)
  ipoTimeHorizon            String?        @map("ipo_time_horizon") @db.VarChar(100) // e.g., "3-5 years"

  // Description & Content
  briefDescription          String         @map("brief_description") @db.VarChar(2000)
  fullDescription           String?        @map("full_description") @db.Text
  vision                    String?        @db.Text
  mission                   String?        @db.Text
  growthPlans               String?        @map("growth_plans") @db.Text

  // Contact Information
  contactEmail              String         @map("contact_email") @db.VarChar(255)
  contactPhone              String         @map("contact_phone") @db.VarChar(20)
  website                   String?        @db.VarChar(255)

  // Social Media (optional)
  facebookUrl               String?        @map("facebook_url") @db.VarChar(255)
  linkedinUrl               String?        @map("linkedin_url") @db.VarChar(255)
  twitterUrl                String?        @map("twitter_url") @db.VarChar(255)

  // Logo
  logoUrl                   String?        @map("logo_url") @db.VarChar(500)

  // Status & Approval
  status                    BusinessStatus @default(PENDING)
  rejectionReason           String?        @map("rejection_reason") @db.Text
  isActive                  Boolean        @default(true) @map("is_active")

  // Metadata
  viewCount                 Int            @default(0) @map("view_count")
  isFeatured                Boolean        @default(false) @map("is_featured")
  createdAt                 DateTime       @default(now()) @map("created_at")
  updatedAt                 DateTime       @updatedAt @map("updated_at")

  // Relations
  businessLogin             BusinessLogin  @relation(fields: [businessLoginId], references: [id], onDelete: Cascade)
  category                  Category       @relation(fields: [categoryId], references: [id])
  media                     BusinessMedia[]
  interests                 InterestSubmission[]
  removalRequests           BusinessRemovalRequest[]

  @@index([businessLoginId])
  @@index([categoryId])
  @@index([status])
  @@index([location])
  @@index([isFeatured])
  @@index([createdAt(sort: Desc)])
  @@map("businesses")
}

// Business Media (Videos, Documents, Brochures, etc.)
model BusinessMedia {
  id             String              @id @default(uuid()) @db.Uuid
  businessId     String              @map("business_id") @db.Uuid
  mediaType      MediaType           @map("media_type")

  // File upload fields (optional if externalUrl is provided)
  fileName       String?             @map("file_name") @db.VarChar(255)
  fileUrl        String?             @map("file_url") @db.VarChar(500)
  fileSize       BigInt?             @map("file_size")
  mimeType       String?             @map("mime_type") @db.VarChar(100)

  // External URL field (for YouTube videos, company website links, etc.)
  externalUrl    String?             @map("external_url") @db.VarChar(500)

  title          String?             @db.VarChar(200)
  description    String?             @db.Text
  displayOrder   Int                 @default(0) @map("display_order")

  // Approval system
  approvalStatus MediaApprovalStatus @default(PENDING) @map("approval_status")
  rejectionReason String?            @map("rejection_reason") @db.Text

  uploadedAt     DateTime            @default(now()) @map("uploaded_at")
  approvedAt     DateTime?           @map("approved_at")

  // Relations
  business       Business            @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([mediaType])
  @@index([approvalStatus])
  @@map("business_media")
}

// Interest Submissions (Investors expressing interest)
model InterestSubmission {
  id              String   @id @default(uuid()) @db.Uuid
  businessId      String   @map("business_id") @db.Uuid
  investorName    String   @map("investor_name") @db.VarChar(100)
  phoneNumber     String   @map("phone_number") @db.VarChar(20)
  email           String   @db.VarChar(255)
  message         String?  @db.Text // Investment interest details message
  hasConsent      Boolean  @default(true) @map("has_consent") // User agreed to Terms & Conditions
  submittedAt     DateTime @default(now()) @map("submitted_at")

  // Follow-up tracking fields
  contacted       Boolean  @default(false) // Whether the business has contacted the investor
  followUpRemarks String?  @map("follow_up_remarks") @db.Text // Legacy field - kept for backward compatibility

  // Relations
  business      Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  followUps     InterestFollowUp[]

  @@index([businessId])
  @@index([email])
  @@index([submittedAt(sort: Desc)])
  @@map("interest_submissions")
}

// Interest Follow-ups (Multiple follow-up entries per interest)
model InterestFollowUp {
  id                    String   @id @default(uuid()) @db.Uuid
  interestSubmissionId  String   @map("interest_submission_id") @db.Uuid
  followUpNumber        Int      @map("follow_up_number") // 1, 2, 3, etc.
  remarks               String   @db.Text
  createdAt             DateTime @default(now()) @map("created_at")

  // Relations
  interestSubmission    InterestSubmission @relation(fields: [interestSubmissionId], references: [id], onDelete: Cascade)

  @@index([interestSubmissionId])
  @@index([followUpNumber])
  @@map("interest_follow_ups")
}

// Business Onboarding Requests (Pre-registration form submissions)
model BusinessOnboardingRequest {
  id              String           @id @default(uuid()) @db.Uuid
  businessName    String           @map("business_name") @db.VarChar(255)
  email           String           @db.VarChar(255)
  phoneNumber     String           @map("phone_number") @db.VarChar(20)
  message         String?          @db.Text
  status          OnboardingStatus @default(PENDING)
  rejectionReason String?          @map("rejection_reason") @db.Text

  // Onboarding link (sent by admin after approval)
  onboardingToken String?          @unique @map("onboarding_token") @db.VarChar(255)
  tokenExpiresAt  DateTime?        @map("token_expires_at")

  // Tracking
  submittedAt          DateTime       @default(now()) @map("submitted_at")
  reviewedAt           DateTime?      @map("reviewed_at")
  createdBusinessLoginId String?      @unique @map("created_business_login_id") @db.Uuid // Link to BusinessLogin when account is created

  // Relations
  createdBusinessLogin BusinessLogin? @relation("BusinessLoginOnboardingRequest", fields: [createdBusinessLoginId], references: [id])

  @@index([email])
  @@index([status])
  @@index([submittedAt(sort: Desc)])
  @@map("business_onboarding_requests")
}

// Business Removal Requests (Businesses requesting profile removal)
model BusinessRemovalRequest {
  id              String   @id @default(uuid()) @db.Uuid
  businessId      String   @map("business_id") @db.Uuid
  reason          String?  @db.Text
  status          String   @default("PENDING") @db.VarChar(50) // PENDING, APPROVED, REJECTED
  requestedAt     DateTime @default(now()) @map("requested_at")
  reviewedAt      DateTime? @map("reviewed_at")
  reviewedBy      String?  @map("reviewed_by") @db.Uuid // Admin ID who reviewed

  // Relations
  business        Business @relation(fields: [businessId], references: [id], onDelete: Cascade)

  @@index([businessId])
  @@index([status])
  @@index([requestedAt(sort: Desc)])
  @@map("business_removal_requests")
}
